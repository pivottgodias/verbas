<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gerador de Dossiê</title>
</head>
<body>
  <h1>Cadastro de Verba</h1>

  <form id="form-dossie">
    <label for="tipoVerba">Tipo de Verba:</label>
    <select id="tipoVerba" name="tipoVerba" required>
      <option value="">Selecione...</option>
      <option value="SELL IN">SELL IN</option>
      <option value="SELL OUT">SELL OUT</option>
      <option value="MERCHANDISING">MERCHANDISING</option>
    </select><br><br>

    <label for="upload_files">Enviar arquivos (PDFs ou Imagens):</label>
    <input type="file" id="upload_files" accept=".pdf,.jpg,.jpeg,.png" multiple required /><br><br>

    <button type="submit">Gerar Dossiê</button>
  </form>

  <!-- jsPDF e pdf-lib -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

  <script>
    const form = document.getElementById('form-dossie');
    const input = document.getElementById('upload_files');
    const tipoVerba = document.getElementById('tipoVerba');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const files = input.files;
      if (!files.length) return alert("Envie pelo menos um arquivo.");
      if (!tipoVerba.value) return alert("Selecione o tipo de verba.");

      const { jsPDF } = window.jspdf;
      const pdfDoc = await PDFLib.PDFDocument.create();

      // Capa
      const page = pdfDoc.addPage([595.28, 841.89]); // A4 em pontos
      const font = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);
      const now = new Date().toLocaleDateString();
      page.drawText("Dossiê de Verba", { x: 50, y: 750, size: 26, font });
      page.drawText(`Tipo de Verba: ${tipoVerba.value}`, { x: 50, y: 720, size: 16 });
      page.drawText(`Data de Geração: ${now}`, { x: 50, y: 700, size: 12 });

      // Processa arquivos
      for (const file of files) {
        const type = file.type;

        if (type.startsWith("image/")) {
          const imgBytes = await file.arrayBuffer();
          try {
            const image = type.includes("png")
              ? await pdfDoc.embedPng(imgBytes)
              : await pdfDoc.embedJpg(imgBytes);

            const imgDims = image.scale(0.5);
            const imgPage = pdfDoc.addPage([image.width, image.height]);
            imgPage.drawImage(image, {
              x: 0,
              y: 0,
              width: image.width,
              height: image.height,
            });
          } catch (error) {
            console.error("Erro ao adicionar imagem:", error);
          }

        } else if (type === "application/pdf") {
          const existingPdfBytes = await file.arrayBuffer();
          const donorPdf = await PDFLib.PDFDocument.load(existingPdfBytes);
          const copiedPages = await pdfDoc.copyPages(donorPdf, donorPdf.getPageIndices());
          copiedPages.forEach(p => pdfDoc.addPage(p));
        }
      }

      const finalPdf = await pdfDoc.save();
      const blob = new Blob([finalPdf], { type: 'application/pdf' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `dossie-${tipoVerba.value.toLowerCase()}.pdf`;
      link.click();
    });
  </script>
</body>
</html>
