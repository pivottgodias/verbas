<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <!-- Meta tag para responsividade -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro de Verba</title>
  <style>
    /* Reset básico */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f8f9fa;
    }
    h2, h3 {
      text-align: center;
      color: white;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
    }
    h2 { background-color: #007BFF; }
    h3 { background-color: #0056b3; font-size: 20px; }
    form {
      background-color: white;
      padding: 25px;
      border-radius: 8px;
      width: 90%;
      max-width: 900px;
      margin: auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    /* Estilo para os campos comuns */
    .common-fields .row {
      display: flex;
      gap: 30px;
      margin-bottom: 10px;
    }
    .common-fields .row > div { flex: 1; }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    /* Navegação de abas (tabs) */
    .tabs-nav {
      list-style: none;
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #007BFF;
    }
    .tabs-nav li {
      flex: 1;
      max-width: 200px;
      padding: 12px 20px;
      background-color: #007BFF;
      color: #fff;
      text-align: center;
      cursor: pointer;
      border-top-left-radius: 5px;
      border-top-right-radius: 5px;
      transition: background-color 0.3s ease, transform 0.3s ease;
    }
    .tabs-nav li:hover {
      background-color: #0056b3;
      transform: scale(1.03);
    }
    .tabs-nav li.active {
      background-color: #0056b3;
      transform: scale(1);
    }
    /* Conteúdos das abas */
    .tab-content {
      display: none;
      padding: 20px 0;
    }
    .tab-content.active {
      display: block;
    }
    /* Estilização para os itens dinâmicos de SELL IN / SELL OUT */
    .item-row, .merch-item-row {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .item-row .row, .merch-item-row .row {
      margin-bottom: 10px;
      display: flex;
      gap: 30px;
    }
    .remove-item, .remove-merch-item {
      background-color: #dc3545;
      border: none;
      color: #fff;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
    }
    .remove-item:hover, .remove-merch-item:hover {
      background-color: #c82333;
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover { background-color: #218838; }
    #add-item, #add-merch-item, #add-item-sell-in, #add-item-sell-out {
      background-color: #007BFF;
    }
    #add-item:hover, #add-merch-item:hover, #add-item-sell-in:hover, #add-item-sell-out:hover {
      background-color: #0056b3;
    }
    /* Estilização para o campo de upload */
    .file-upload {
      margin-top: 20px;
      text-align: center;
    }
    .file-upload label {
      font-weight: bold;
      margin-bottom: 8px;
      display: block;
    }
    .file-upload input[type="file"] {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    @media (max-width: 600px) {
      .common-fields .row,
      .item-row .row,
      .merch-item-row .row {
        flex-direction: column;
        gap: 15px;
      }
      .tabs-nav { flex-direction: column; }
    }
  </style>
</head>
<body>
  <h2>Cadastro de Verba</h2>
  <form id="form-dossie">
    <!-- Campos comuns -->
    <div class="common-fields">
      <!-- ... (sem alterações) ... -->
    </div>
    
    <!-- Abas -->
    <ul class="tabs-nav">
      <!-- ... (sem alterações) ... -->
    </ul>
    
    <!-- SELL OUT -->
    <div class="tab-content active" id="sell-out">
      <h3>Itens - SELL OUT</h3>
      <div id="items-container-sell-out">
        <!-- ... (template original) ... -->
      </div>
      <button type="button" id="add-item-sell-out">Adicionar item</button>
    </div>
    
    <!-- SELL IN -->
    <div class="tab-content" id="sell-in">
      <h3>Itens - SELL IN</h3>
      <div id="items-container-sell-in">
        <!-- ... (template original) ... -->
      </div>
      <button type="button" id="add-item-sell-in">Adicionar item</button>
    </div>
    
    <!-- MERCHANDISING -->
    <div class="tab-content" id="merchandising">
      <h3>Itens - Merchandising</h3>
      <div id="merch-items-container">
        <!-- ... (template original) ... -->
      </div>
      <button type="button" id="add-merch-item">Adicionar item</button>
    </div>

    <!-- Único campo de upload para o dossiê -->
    <div class="file-upload">
      <label for="dossie_files">Arquivos para o Dossiê (.pdf, .jpg, .png):</label>
      <input type="file" id="dossie_files" name="dossie_files[]" accept=".pdf,.jpg,.jpeg,.png" multiple>
    </div>

    <br><br>
    <button type="submit">Salvar e Gerar Dossiê</button>
  </form>

  <!-- Botão para disparar DocuSign após gerar o PDF -->
  <button id="btn-docusign" style="display:none; margin:20px auto; display:block;">
    Enviar para Assinatura (DocuSign)
  </button>

  <!-- pdf-lib -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script>
    // (mantém todo o JS original de abas, itens e remoções)

    // Função auxiliar: coleta todos os itens de uma aba
    function collectItems(containerId) {
      const rows = document.querySelectorAll(`#${containerId} .item-row, #${containerId} .merch-item-row`);
      return Array.from(rows).map(row => {
        const texts = [...row.querySelectorAll('input, select')]
          .map(el => el.value || '')
          .join(' | ');
        return texts;
      });
    }

    // Geração do Dossiê em PDF, incluindo itens
    document.getElementById('form-dossie').addEventListener('submit', async e => {
      e.preventDefault();

      const files = document.getElementById('dossie_files').files;
      if (!files.length) return alert("Selecione ao menos um arquivo para o dossiê.");

      // dados comuns
      const rede = document.getElementById('rede').value;
      const mercado = document.getElementById('mercado').value;
      const cidade = document.getElementById('cidade').value;
      const uf = document.getElementById('uf').value;
      const vendedor = document.getElementById('vendedor').value;
      const contrato = document.getElementById('contrato').value;
      const tipoVerba = document.querySelector('.tabs-nav li.active').textContent;

      // coleta itens por aba
      const sellOutItems = collectItems('items-container-sell-out');
      const sellInItems = collectItems('items-container-sell-in');
      const merchItems   = collectItems('merch-items-container');

      // cria PDF
      const pdfDoc = await PDFLib.PDFDocument.create();
      const page = pdfDoc.addPage([595.28, 841.89]);
      const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
      let y = 800;
      page.drawText("Dossiê de Verba", { x:50, y, size:24, font });
      y -= 30;
      // cria tabela simples de campos comuns
      [
        `Rede: ${rede}`,
        `Mercado: ${mercado}`,
        `Cidade/UF: ${cidade} - ${uf}`,
        `Vendedor: ${vendedor}`,
        `Contrato: ${contrato}`,
        `Tipo de Verba: ${tipoVerba}`,
        `Data: ${new Date().toLocaleDateString()}`
      ].forEach(line => {
        page.drawText(line, { x:50, y, size:12, font });
        y -= 18;
      });

      // função para desenhar listas de itens
      function drawSection(title, items) {
        page.drawText(title, { x:50, y, size:14, font });
        y -= 20;
        items.forEach(text => {
          page.drawText(text, { x:60, y, size:10, font });
          y -= 14;
          if (y < 50) {
            // adiciona nova página se necessário
            y = 800;
            page = pdfDoc.addPage([595.28, 841.89]);
          }
        });
        y -= 10;
      }

      drawSection("SELL OUT:", sellOutItems);
      drawSection("SELL IN:",  sellInItems);
      drawSection("MERCHANDISING:", merchItems);

      // incorpora uploads (pdf e imagens)
      for (const file of files) {
        const buf = await file.arrayBuffer();
        if (file.type.startsWith("image/")) {
          const img = file.type === "image/png"
            ? await pdfDoc.embedPng(buf)
            : await pdfDoc.embedJpg(buf);
          const imgPage = pdfDoc.addPage([595.28, 841.89]);
          const { width, height } = imgPage.getSize();
          const dims = img.scaleToFit(width - 40, height - 40);
          imgPage.drawImage(img, {
            x:20, y: height - dims.height - 20,
            width: dims.width, height: dims.height
          });
        } else if (file.type === "application/pdf") {
          const donor = await PDFLib.PDFDocument.load(buf);
          const copied = await pdfDoc.copyPages(donor, donor.getPageIndices());
          copied.forEach(p => pdfDoc.addPage(p));
        }
      }

      // gera o blob e mostra botão DocuSign
      const pdfBytes = await pdfDoc.save();
      window._lastPdfBlob = new Blob([pdfBytes], { type:'application/pdf' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(window._lastPdfBlob);
      link.download = `dossie_${tipoVerba.toLowerCase().replace(/ /g,'_')}.pdf`;
      link.click();

      // exibe botão para enviar ao DocuSign
      document.getElementById('btn-docusign').style.display = 'block';
    });

    // stub de integração DocuSign
    document.getElementById('btn-docusign').addEventListener('click', () => {
      const blob = window._lastPdfBlob;
      if (!blob) return alert("Gere primeiro o PDF.");
      sendToDocuSign(blob);
    });

    // Exemplo de função que você deve implementar no seu back-end
    async function sendToDocuSign(pdfBlob) {
      const reader = new FileReader();
      reader.onload = async () => {
        const base64Pdf = reader.result.split(',')[1];
        // Exemplo de chamada (ajuste URL e headers conforme sua API)
        await fetch('/api/docusign/envelope', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({
            name: 'Dossiê de Verba',
            pdfBase64: base64Pdf,
            signers: [ /* seu array de signatários */ ]
          })
        });
        alert('Solicitação de assinatura enviada!');
      };
      reader.readAsDataURL(pdfBlob);
    }
  </script>
</body>
</html>
