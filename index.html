<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Gerador de Dossiê</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    .item-container { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background-color: #f0f0f0; text-transform: uppercase; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
  </style>
</head>
<body>

  <h1>Cadastro de Verba</h1>

  <label for="tipoVerba">Tipo de Verba:</label>
  <select id="tipoVerba">
    <option value="SELL IN">SELL IN</option>
    <option value="SELL OUT">SELL OUT</option>
    <option value="MERCHANDISING">MERCHANDISING</option>
  </select>

  <div id="camposComuns">
    <label for="familia" class="sr-only">Família</label>
    <input type="text" placeholder="Família" id="familia" />
    
    <label for="produto" class="sr-only">Produto</label>
    <input type="text" placeholder="Produto" id="produto" />
    
    <label for="unidades" class="sr-only">Unidades</label>
    <input type="number" placeholder="Unidades" id="unidades" />
    
    <label for="verba" class="sr-only">Verba</label>
    <input type="text" placeholder="Verba" id="verba" oninput="this.value = this.value.replace(/[^0-9.,]/g, '')" />
    
    <label for="bonificacao" class="sr-only">Bonificação</label>
    <input type="text" placeholder="Bonificação" id="bonificacao" oninput="this.value = this.value.replace(/[^0-9.,]/g, '')" />
    
    <label for="ttc" class="sr-only">TTC</label>
    <input type="text" placeholder="TTC" id="ttc" />
    
    <label for="ttv" class="sr-only">TTV</label>
    <input type="text" placeholder="TTV" id="ttv" />
  </div>

  <button onclick="addItem()">Adicionar Item</button>

  <!-- Divs de itens mantidas como original -->
  <div id="SELL IN" class="item-container">
    <h3>Itens SELL IN</h3>
    <table><thead><tr><th>Família</th><th>Produto</th><th>Unidades</th><th>Verba</th><th>Bonificação</th><th>TTC</th><th>TTV</th></tr></thead><tbody></tbody></table>
  </div>
  <!-- Repetir para SELL OUT e MERCHANDISING -->

  <button onclick="generatePDF()">Gerar Dossiê PDF</button>

  <script>
    function addItem() {
      const tipo = document.getElementById("tipoVerba").value;
      const campos = [
        { id: "familia", nome: "Família", obrigatorio: true },
        { id: "produto", nome: "Produto", obrigatorio: true },
        { id: "unidades", nome: "Unidades", obrigatorio: true },
        { id: "verba", nome: "Verba", obrigatorio: false },
        { id: "bonificacao", nome: "Bonificação", obrigatorio: false },
        { id: "ttc", nome: "TTC", obrigatorio: false },
        { id: "ttv", nome: "TTV", obrigatorio: false }
      ];

      // Validação
      let valido = true;
      campos.forEach(campo => {
        const valor = document.getElementById(campo.id).value.trim();
        if (campo.obrigatorio && !valor) {
          alert(`O campo ${campo.nome} é obrigatório`);
          valido = false;
        }
        if ((campo.id === "verba" || campo.id === "bonificacao") && valor && isNaN(parseFloat(valor.replace(',', '.')))) {
          alert(`O campo ${campo.nome} deve ser numérico`);
          valido = false;
        }
      });
      if (!valido) return;

      // Criação do item
      const tableBody = document.querySelector(`#${tipo} tbody`);
      const row = document.createElement("tr");

      campos.forEach(campo => {
        const td = document.createElement("td");
        td.textContent = document.getElementById(campo.id).value;
        row.appendChild(td);
      });

      tableBody.appendChild(row);

      // Limpeza
      campos.forEach(campo => {
        if (campo.id !== "tipoVerba") {
          document.getElementById(campo.id).value = "";
        }
      });
    }

    function collectItems() {
      const tipos = ["SELL IN", "SELL OUT", "MERCHANDISING"];
      const data = {};

      tipos.forEach(tipo => {
        const rows = document.querySelectorAll(`#${tipo} tbody tr`);
        if (rows.length > 0) {
          data[tipo] = Array.from(rows).map(row => {
            return Array.from(row.children).map(td => td.textContent);
          });
        }
      });

      return data;
    }

    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text("DOSSIÊ DE VERBAS", 14, 15);
      doc.setFontSize(10);
      
      // Data formatada
      const date = new Date();
      const formattedDate = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth()+1).toString().padStart(2, '0')}/${date.getFullYear()}`;
      doc.text(`Data: ${formattedDate}`, 14, 22);

      const items = collectItems();
      let y = 30;

      Object.entries(items).forEach(([tipo, dados]) => {
        doc.setFontSize(12);
        doc.text(`${tipo}`, 14, y);
        y += 5;
        
        // Formata valores monetários
        const formattedData = dados.map(row => {
          return row.map((cell, idx) => {
            if ([3,4].includes(idx)) { // Verba e Bonificação
              const value = cell.replace(',', '.');
              return isNaN(value) ? cell : `R$ ${parseFloat(value).toFixed(2).replace('.', ',')}`;
            }
            return cell;
          });
        });

        doc.autoTable({
          startY: y,
          head: [["FAMÍLIA", "PRODUTO", "UNIDADES", "VERBA", "BONIFICAÇÃO", "TTC", "TTV"]],
          body: formattedData,
          theme: 'grid',
          styles: { fontSize: 9 },
          headStyles: { fillColor: [200, 200, 200] }
        });
        y = doc.lastAutoTable.finalY + 10;
      });

      doc.save("dossie_verbas.pdf");
    }
  </script>
</body>
</html>
