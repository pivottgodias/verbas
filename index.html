<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro de Verba</title>
  <style>
    /* Estilos omitidos por brevidade */
  </style>
</head>
<body>
  <h2>Cadastro de Verba</h2>
  <form id="form-dossie">
    <!-- Formulário omitido por brevidade -->
    <div class="file-upload">
      <label for="dossie_files">Arquivos (PDF/Imagens):</label>
      <input type="file" id="dossie_files" name="dossie_files[]" accept=".pdf,.jpg,.jpeg,.png" multiple>
    </div>
    <button type="submit" class="btn-submit">Salvar e Gerar Dossiê</button>
  </form>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
  <script>
    document.getElementById('form-dossie').addEventListener('submit', async function(event) {
      event.preventDefault();

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Dados básicos
      const rede = document.getElementById('rede').value || 'Sem Rede';
      const vendedor = document.getElementById('vendedor').value || '';
      const uf = document.getElementById('uf').value || '';
      const cidade = document.getElementById('cidade').value || '';

      doc.text(`Dossiê de Verba`, 10, 10);
      doc.text(`Rede: ${rede}`, 10, 20);
      doc.text(`UF: ${uf}`, 10, 30);
      doc.text(`Cidade: ${cidade}`, 10, 40);
      doc.text(`Vendedor: ${vendedor}`, 10, 50);

      let startY = 60;

      // Função para adicionar tabelas ao PDF (omitida por brevidade)

      // Adicionar arquivos (PDFs ou imagens)
      const filesInput = document.getElementById('dossie_files');
      if (filesInput.files.length > 0) {
        // Criar um novo PDF usando pdf-lib para mesclar os PDFs
        const mergedPdf = await PDFLib.PDFDocument.create();

        // Converter o PDF principal (gerado pelo jsPDF) para bytes
        const pdfBytes = await doc.output('arraybuffer');
        const mainPdf = await PDFLib.PDFDocument.load(pdfBytes);

        // Copiar as páginas do PDF principal para o PDF mesclado
        const mainPages = await mergedPdf.copyPages(mainPdf, mainPdf.getPageIndices());
        mainPages.forEach(page => mergedPdf.addPage(page));

        for (const file of filesInput.files) {
          if (file.type === 'application/pdf') {
            try {
              // Carregar o PDF anexado
              const pdfBytes = await file.arrayBuffer();
              const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
              const pages = pdfDoc.getPages();

              // Copiar as páginas do PDF anexado para o PDF mesclado
              const copiedPages = await mergedPdf.copyPages(pdfDoc, pdfDoc.getPageIndices());
              copiedPages.forEach(page => mergedPdf.addPage(page));
            } catch (error) {
              console.error("Erro ao processar o PDF:", error);
            }
          } else {
            // Processar Imagem
            const reader = new FileReader();
            reader.onload = async function(event) {
              const dataUrl = event.target.result;
              const imgProps = await new Promise(resolve => {
                const img = new Image();
                img.src = dataUrl;
                img.onload = () => resolve({ width: img.width, height: img.height });
              });

              const maxWidth = 180; // Largura máxima da imagem no PDF
              const scale = maxWidth / imgProps.width;
              const imgWidth = maxWidth;
              const imgHeight = imgProps.height * scale;

              // Adicionar uma nova página para a imagem
              mergedPdf.addPage([imgWidth, imgHeight]);
              const page = mergedPdf.getPage(mergedPdf.getPageCount() - 1);
              const embeddedImage = await mergedPdf.embedPng(dataUrl);
              page.drawImage(embeddedImage, {
                x: 0,
                y: 0,
                width: imgWidth,
                height: imgHeight,
              });
            };
            reader.onerror = function(error) {
              console.error("Erro ao ler o arquivo:", error);
            };
            reader.readAsDataURL(file);
          }
        }

        // Salvar o PDF mesclado
        const mergedPdfBytes = await mergedPdf.save();
        const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `dossie-${rede}.pdf`;
        a.click();
        URL.revokeObjectURL(url);
      } else {
        // Se não houver arquivos anexados, salvar apenas o PDF principal
        doc.save(`dossie-${rede}.pdf`);
      }
    });
  </script>
</body>
</html>
